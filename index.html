<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Crachá - CETEP</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            min-height: 100vh;
            color: #1e3a8a;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            gap: 1.5rem;
            align-items: start;
        }

        .header {
            grid-column: 1 / -1;
            text-align: center;
            margin-bottom: 1rem;
        }

        .header h1 {
            color: white;
            font-size: 2.2rem;
            font-weight: 300;
            margin-bottom: 0.3rem;
        }

        .header p {
            color: rgba(255, 255, 255, 0.8);
            font-size: 1rem;
        }

        .upload-panel, .controls-panel {
            background: white;
            border-radius: 12px;
            padding: 1.2rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }

        .canvas-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
            border-radius: 12px;
            padding: 1.2rem;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
            height: fit-content;
        }

        .upload-section {
            margin-bottom: 1.2rem;
        }

        .upload-section:last-child {
            margin-bottom: 0;
        }

        .upload-section h3 {
            font-size: 0.95rem;
            font-weight: 600;
            color: #1e3a8a;
            margin-bottom: 0.8rem;
        }

        .control-group {
            margin-bottom: 1.2rem;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.4rem;
            color: #1e3a8a;
            font-size: 0.85rem;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input {
            display: none;
        }

        .file-input-button {
            display: inline-block;
            width: 100%;
            padding: 0.7rem;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .file-input-button:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(59, 130, 246, 0.3);
        }

        .slider-container {
            margin-top: 0.4rem;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e5e7eb;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .text-input {
            width: 100%;
            padding: 0.7rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            background: #f9fafb;
        }

        .text-input:focus {
            outline: none;
            border-color: #3b82f6;
            background: white;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        #canvas {
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            max-width: 100%;
            height: auto;
            border: 1px solid #e5e7eb;
        }

        .generate-section {
            grid-column: 1 / -1;
            text-align: center;
            margin-top: 1.5rem;
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .generate-btn, .print-btn {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            color: white;
            border: none;
            padding: 0.9rem 2rem;
            font-size: 1rem;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .print-btn {
            background: linear-gradient(135deg, #059669, #10b981);
        }

        .generate-btn:hover, .print-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.4);
        }

        .print-btn:hover {
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.4);
        }

        .download-section {
            margin-top: 1.5rem;
        }

        .download-link {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 0.8rem 1.5rem;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .download-link:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .slider-value {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 0.2rem;
            text-align: center;
        }

        .zoom-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0.4rem;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-btn:hover {
            background: #2563eb;
            transform: scale(1.05);
        }

        .zoom-controls {
            display: flex;
            gap: 0.4rem;
            align-items: center;
            margin-top: 0.4rem;
        }

        .zoom-controls input[type="range"] {
            flex: 1;
        }

        /* Responsividade melhorada */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                gap: 1rem;
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }

            .generate-section {
                margin-top: 1rem;
            }
            
            .upload-panel, .controls-panel, .canvas-container {
                max-width: 500px;
                margin: 0 auto;
            }
        }

        @media (max-width: 900px) {
            .container {
                padding: 0.5rem;
            }
            
            .header h1 {
                font-size: 1.6rem;
            }
            
            .generate-section {
                flex-direction: column;
                align-items: center;
            }
            
            .generate-btn, .print-btn {
                width: 200px;
            }
        }

        /* CSS específico para impressão */
        @media print {
            body {
                background: white;
            }
            
            .container {
                display: block;
            }
            
            .upload-panel,
            .controls-panel,
            .generate-section {
                display: none !important;
            }
            
            .canvas-container {
                box-shadow: none;
                border-radius: 0;
                padding: 0;
            }
            
            #canvas {
                width: 85mm !important;
                height: 54mm !important;
                box-shadow: none;
                border: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Gerador de Crachá CETEP</h1>
            <p>Crie seu crachá personalizado de forma simples e moderna</p>
        </div>

        <!-- Painel de Upload (Esquerda) -->
        <div class="upload-panel">
            <div class="upload-section">
                <h3>📄 Modelo do Crachá (PNG)</h3>
                <div class="file-input-wrapper">
                    <input type="file" id="uploadModel" class="file-input" accept="image/png">
                    <label for="uploadModel" class="file-input-button">Carregar Modelo PNG</label>
                </div>
                <p style="font-size: 0.75rem; color: #6b7280; margin-top: 0.5rem;">
                    ⚠️ Use PNG com área transparente para foto
                </p>
            </div>

            <div class="upload-section">
                <h3>📸 Foto do Usuário</h3>
                <div class="file-input-wrapper">
                    <input type="file" id="uploadImage" class="file-input" accept="image/*">
                    <label for="uploadImage" class="file-input-button">Carregar Foto</label>
                </div>
            </div>
        </div>

        <!-- Preview do Crachá (Centro) -->
        <div class="canvas-container">
            <canvas id="canvas" width="300" height="400"></canvas>
        </div>

        <!-- Controles de Edição (Direita) -->
        <div class="controls-panel">
            <div class="control-group">
                <label for="brightness">Brilho</label>
                <div class="slider-container">
                    <input type="range" id="brightness" class="slider" min="-50" max="50" value="0">
                    <div class="slider-value" id="brightnessValue">0</div>
                </div>
            </div>

            <div class="control-group">
                <label for="contrast">Contraste</label>
                <div class="slider-container">
                    <input type="range" id="contrast" class="slider" min="-50" max="50" value="0">
                    <div class="slider-value" id="contrastValue">0</div>
                </div>
            </div>

            <!-- Controles de Posicionamento - SEMPRE VISÍVEIS -->
            <div class="control-group" id="imageControls">
                <label>🎯 Posicionamento da Imagem</label>
                
                <div style="margin-bottom: 0.8rem;">
                    <label for="positionX" style="font-size: 0.75rem; margin-bottom: 0.2rem;">Posição X (Horizontal)</label>
                    <div class="slider-container">
                        <input type="range" id="positionX" class="slider" min="-100" max="100" value="0">
                        <div class="slider-value" id="positionXValue">0</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 0.8rem;">
                    <label for="positionY" style="font-size: 0.75rem; margin-bottom: 0.2rem;">Posição Y (Vertical)</label>
                    <div class="slider-container">
                        <input type="range" id="positionY" class="slider" min="-100" max="100" value="0">
                        <div class="slider-value" id="positionYValue">0</div>
                    </div>
                </div>
                
                <div style="margin-bottom: 0.8rem;">
                    <label>🔍 Zoom da Imagem</label>
                    <div class="zoom-controls">
                        <button type="button" id="zoomOut" class="zoom-btn">−</button>
                        <input type="range" id="zoom" class="slider" min="50" max="200" value="100">
                        <button type="button" id="zoomIn" class="zoom-btn">+</button>
                    </div>
                    <div class="slider-value" id="zoomValue">100%</div>
                </div>
            </div>

            <div class="control-group">
                <label for="name">Nome Completo</label>
                <input type="text" id="name" class="text-input" placeholder="Digite o nome">
            </div>

            <div class="control-group">
                <label for="role">Função/Curso</label>
                <input type="text" id="role" class="text-input" placeholder="Ex: TÉCNICO EM INFORMÁTICA">
            </div>

            <div class="control-group">
                <label for="location">Local</label>
                <input type="text" id="location" class="text-input" placeholder="Ex: ALAGOINHAS">
            </div>
        </div>

        <div class="generate-section">
            <button id="generateCard" class="generate-btn">Gerar Crachá</button>
            <button id="printCard" class="print-btn">🖨️ Imprimir</button>
            <div id="downloadSection" class="download-section" style="display:none;">
                <a id="downloadLink" href="#" class="download-link" download="cracha-cetep.png">⬇️ Baixar Crachá</a>
            </div>
        </div>
    </div>

    <script>
        // Variáveis globais
        let userImage = null;
        let modelImage = null;
        let canvas = document.getElementById('canvas');
        let ctx = canvas.getContext('2d');

        // Variáveis para controle da imagem
        let imagePosition = { x: 0, y: 0 };
        let imageZoom = 1;

        // Configurações de qualidade - Padrão de crachá 85x54mm em 300 DPI
        const PRINT_WIDTH_MM = 85;
        const PRINT_HEIGHT_MM = 54;
        const DPI = 300;
        const PIXELS_PER_MM = DPI / 25.4;
        const PRINT_WIDTH_PX = Math.round(PRINT_WIDTH_MM * PIXELS_PER_MM);
        const PRINT_HEIGHT_PX = Math.round(PRINT_HEIGHT_MM * PIXELS_PER_MM);

        // Configurar canvas com alta resolução
        const SCALE_FACTOR = 3;
        canvas.width = 300 * SCALE_FACTOR;
        canvas.height = 400 * SCALE_FACTOR;
        canvas.style.width = '300px';
        canvas.style.height = '400px';

        // Configurar contexto para alta qualidade
        ctx.scale(SCALE_FACTOR, SCALE_FACTOR);
        ctx.imageSmoothingEnabled = true;
        ctx.imageSmoothingQuality = 'high';
        ctx.textRenderingOptimization = 'optimizeQuality';

        // Event Listeners para upload de arquivos
        document.getElementById('uploadModel').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.type !== 'image/png') {
                    alert('Por favor, selecione apenas arquivos PNG com transparência.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    modelImage = new Image();
                    modelImage.onload = function() {
                        drawBadge();
                    };
                    modelImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('uploadImage').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    userImage = new Image();
                    userImage.onload = function() {
                        processUserImage();
                    };
                    userImage.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        });

        // Função para processar a imagem do usuário
        function processUserImage() {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            
            const aspectRatio = userImage.width / userImage.height;
            const targetWidth = 800;
            const targetHeight = Math.round(targetWidth / aspectRatio);
            
            tempCanvas.width = targetWidth;
            tempCanvas.height = targetHeight;
            
            tempCtx.imageSmoothingEnabled = true;
            tempCtx.imageSmoothingQuality = 'high';
            tempCtx.drawImage(userImage, 0, 0, targetWidth, targetHeight);
            
            const imageData = tempCtx.getImageData(0, 0, targetWidth, targetHeight);
            const sharpened = applySharpenFilter(imageData);
            tempCtx.putImageData(sharpened, 0, 0);
            
            const processedImage = new Image();
            processedImage.onload = function() {
                userImage = processedImage;
                resetImageControls();
                drawBadge();
            };
            processedImage.src = tempCanvas.toDataURL('image/png', 0.95);
        }

        // Função de filtro de nitidez
        function applySharpenFilter(imageData) {
            const data = imageData.data;
            const width = imageData.width;
            const height = imageData.height;
            const output = new ImageData(width, height);
            const outputData = output.data;
            
            const kernel = [0, -0.3, 0, -0.3, 2.2, -0.3, 0, -0.3, 0];
            
            for (let y = 1; y < height - 1; y++) {
                for (let x = 1; x < width - 1; x++) {
                    for (let c = 0; c < 3; c++) {
                        let sum = 0;
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const pixelIndex = ((y + ky) * width + (x + kx)) * 4 + c;
                                const kernelIndex = (ky + 1) * 3 + (kx + 1);
                                sum += data[pixelIndex] * kernel[kernelIndex];
                            }
                        }
                        const outputIndex = (y * width + x) * 4 + c;
                        outputData[outputIndex] = Math.min(255, Math.max(0, sum));
                    }
                    const alphaIndex = (y * width + x) * 4 + 3;
                    outputData[alphaIndex] = data[alphaIndex];
                }
            }
            return output;
        }

        // Resetar controles de imagem
        function resetImageControls() {
            imagePosition = { x: 0, y: 0 };
            imageZoom = 1;
            document.getElementById('positionX').value = 0;
            document.getElementById('positionY').value = 0;
            document.getElementById('zoom').value = 100;
            updateSliderValues();
        }

        // Event Listeners para controles
        document.getElementById('brightness').addEventListener('input', function() {
            document.getElementById('brightnessValue').textContent = this.value;
            drawBadge();
        });

        document.getElementById('contrast').addEventListener('input', function() {
            document.getElementById('contrastValue').textContent = this.value;
            drawBadge();
        });

        document.getElementById('positionX').addEventListener('input', function() {
            imagePosition.x = parseInt(this.value);
            document.getElementById('positionXValue').textContent = this.value;
            drawBadge();
        });

        document.getElementById('positionY').addEventListener('input', function() {
            imagePosition.y = parseInt(this.value);
            document.getElementById('positionYValue').textContent = this.value;
            drawBadge();
        });

        document.getElementById('zoom').addEventListener('input', function() {
            imageZoom = parseInt(this.value) / 100;
            document.getElementById('zoomValue').textContent = this.value + '%';
            drawBadge();
        });

        // Botões de zoom
        document.getElementById('zoomIn').addEventListener('click', function() {
            const zoomSlider = document.getElementById('zoom');
            const currentValue = parseInt(zoomSlider.value);
            const newValue = Math.min(200, currentValue + 10);
            zoomSlider.value = newValue;
            imageZoom = newValue / 100;
            document.getElementById('zoomValue').textContent = newValue + '%';
            drawBadge();
        });

        document.getElementById('zoomOut').addEventListener('click', function() {
            const zoomSlider = document.getElementById('zoom');
            const currentValue = parseInt(zoomSlider.value);
            const newValue = Math.max(50, currentValue - 10);
            zoomSlider.value = newValue;
            imageZoom = newValue / 100;
            document.getElementById('zoomValue').textContent = newValue + '%';
            drawBadge();
        });

        // Event listeners para campos de texto
        document.getElementById('name').addEventListener('input', drawBadge);
        document.getElementById('role').addEventListener('input', drawBadge);
        document.getElementById('location').addEventListener('input', drawBadge);

        // Atualizar valores dos sliders
        function updateSliderValues() {
            document.getElementById('brightnessValue').textContent = document.getElementById('brightness').value;
            document.getElementById('contrastValue').textContent = document.getElementById('contrast').value;
            document.getElementById('positionXValue').textContent = document.getElementById('positionX').value;
            document.getElementById('positionYValue').textContent = document.getElementById('positionY').value;
            document.getElementById('zoomValue').textContent = document.getElementById('zoom').value + '%';
        }

        // Função principal para desenhar o crachá
        function drawBadge() {
            // Limpar canvas
            ctx.save();
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.restore();

            // PRIMEIRO: Desenhar foto do usuário (atrás do modelo PNG)
            if (userImage) {
                ctx.save();
                
                const brightness = document.getElementById('brightness').value;
                const contrast = document.getElementById('contrast').value;
                ctx.filter = `brightness(${100 + parseInt(brightness)}%) contrast(${100 + parseInt(contrast)}%)`;
                
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                
                // Calcular dimensões com zoom aplicado
                const baseScale = 0.3;
                const scaledWidth = userImage.width * baseScale * imageZoom;
                const scaledHeight = userImage.height * baseScale * imageZoom;
                
                const centerX = 150;
                const centerY = 200;
                
                const drawX = centerX - scaledWidth / 2 + (imagePosition.x * 1.5);
                const drawY = centerY - scaledHeight / 2 + (imagePosition.y * 1.5);
                
                ctx.drawImage(userImage, drawX, drawY, scaledWidth, scaledHeight);
                ctx.restore();
            }

            // SEGUNDO: Desenhar modelo PNG com transparência (por cima da foto)
            if (modelImage) {
                ctx.save();
                ctx.imageSmoothingEnabled = true;
                ctx.imageSmoothingQuality = 'high';
                ctx.drawImage(modelImage, 0, 0, 300, 400);
                ctx.restore();
            }

            // TERCEIRO: Desenhar textos
            drawTexts();
        }

        // Função para desenhar textos
        function drawTexts() {
            const name = document.getElementById('name').value;
            const role = document.getElementById('role').value;
            const location = document.getElementById('location').value;
            
            if (!name && !role && !location) return;
            
            ctx.filter = 'none';
            ctx.imageSmoothingEnabled = true;
            ctx.textRenderingOptimization = 'optimizeQuality';
            ctx.fillStyle = '#1e3a8a';
            ctx.textAlign = 'center';
            
            ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
            ctx.shadowBlur = 1;
            ctx.shadowOffsetY = 0.5;
            
            if (name) {
                ctx.font = 'bold 18px "Segoe UI", Arial, sans-serif';
                ctx.fillText(name, 150, 330);
            }
            
            if (role) {
                ctx.font = '14px "Segoe UI", Arial, sans-serif';
                ctx.fillText(role, 150, 355);
            }
            
            if (location) {
                ctx.font = 'bold 16px "Segoe UI", Arial, sans-serif';
                ctx.fillStyle = '#3b82f6';
                ctx.fillText(location, 150, 380);
            }
            
            ctx.shadowColor = 'transparent';
            ctx.shadowBlur = 0;
            ctx.shadowOffsetY = 0;
        }

        // Gerar crachá para download
        document.getElementById('generateCard').addEventListener('click', function() {
            if (!modelImage) {
                alert('Por favor, carregue um modelo PNG com transparência primeiro.');
                return;
            }
            
            const exportCanvas = document.createElement('canvas');
            const exportCtx = exportCanvas.getContext('2d');
            
            const designRatio = 300 / 400;
            const cardRatio = PRINT_WIDTH_PX / PRINT_HEIGHT_PX;
            
            let canvasWidth, canvasHeight;
            
            if (designRatio > cardRatio) {
                canvasHeight = PRINT_HEIGHT_PX;
                canvasWidth = Math.round(canvasHeight * designRatio);
            } else {
                canvasWidth = PRINT_WIDTH_PX;
                canvasHeight = Math.round(canvasWidth / designRatio);
            }
            
            exportCanvas.width = canvasWidth;
            exportCanvas.height = canvasHeight;
            
            exportCtx.imageSmoothingEnabled = true;
            exportCtx.imageSmoothingQuality = 'high';
            exportCtx.textRenderingOptimization = 'optimizeQuality';
            
            const scaleX = canvasWidth / 300;
            const scaleY = canvasHeight / 400;
            
            // Desenhar foto do usuário
            if (userImage) {
                exportCtx.save();
                
                const brightness = document.getElementById('brightness').value;
                const contrast = document.getElementById('contrast').value;
                exportCtx.filter = `brightness(${100 + parseInt(brightness)}%) contrast(${100 + parseInt(contrast)}%)`;
                
                const baseScale = 0.3;
                const scaledWidth = userImage.width * baseScale * imageZoom * scaleX;
                const scaledHeight = userImage.height * baseScale * imageZoom * scaleY;
                
                const centerX = canvasWidth / 2;
                const centerY = canvasHeight / 2;
                
                const drawX = centerX - scaledWidth / 2 + (imagePosition.x * 1.5 * scaleX);
                const drawY = centerY - scaledHeight / 2 + (imagePosition.y * 1.5 * scaleY);
                
                exportCtx.drawImage(userImage, drawX, drawY, scaledWidth, scaledHeight);
                exportCtx.restore();
            }
            
            // Desenhar modelo PNG
            if (modelImage) {
                exportCtx.drawImage(modelImage, 0, 0, canvasWidth, canvasHeight);
            }
            
            // Desenhar textos
            const name = document.getElementById('name').value;
            const role = document.getElementById('role').value;
            const location = document.getElementById('location').value;
            
            if (name || role || location) {
                exportCtx.filter = 'none';
                exportCtx.fillStyle = '#1e3a8a';
                exportCtx.textAlign = 'center';
                exportCtx.shadowColor = 'rgba(0, 0, 0, 0.1)';
                exportCtx.shadowBlur = 1 * Math.min(scaleX, scaleY);
                exportCtx.shadowOffsetY = 0.5 * Math.min(scaleX, scaleY);
                
                if (name) {
                    exportCtx.font = `bold ${18 * Math.min(scaleX, scaleY)}px "Segoe UI", Arial, sans-serif`;
                    exportCtx.fillText(name, canvasWidth / 2, 330 * scaleY);
                }
                
                if (role) {
                    exportCtx.font = `${14 * Math.min(scaleX, scaleY)}px "Segoe UI", Arial, sans-serif`;
                    exportCtx.fillText(role, canvasWidth / 2, 355 * scaleY);
                }
                
                if (location) {
                    exportCtx.font = `bold ${16 * Math.min(scaleX, scaleY)}px "Segoe UI", Arial, sans-serif`;
                    exportCtx.fillStyle = '#3b82f6';
                    exportCtx.fillText(location, canvasWidth / 2, 380 * scaleY);
                }
            }
            
            const dataURL = exportCanvas.toDataURL('image/png', 1.0);
            const downloadLink = document.getElementById('downloadLink');
            downloadLink.href = dataURL;
            document.getElementById('downloadSection').style.display = 'block';
        });

        // Função de impressão otimizada para crachá 85x54mm
        document.getElementById('printCard').addEventListener('click', function() {
            if (!modelImage) {
                alert('Por favor, carregue um modelo PNG primeiro.');
                return;
            }

            const printCanvas = document.createElement('canvas');
            const printCtx = printCanvas.getContext('2d');
            
            printCanvas.width = PRINT_WIDTH_PX;
            printCanvas.height = PRINT_HEIGHT_PX;
            
            printCtx.imageSmoothingEnabled = true;
            printCtx.imageSmoothingQuality = 'high';
            printCtx.textRenderingOptimization = 'optimizeQuality';
            
            const scaleX = PRINT_WIDTH_PX / 300;
            const scaleY = PRINT_HEIGHT_PX / 400;
            const scale = Math.min(scaleX, scaleY);
            
            const offsetX = (PRINT_WIDTH_PX - 300 * scale) / 2;
            const offsetY = (PRINT_HEIGHT_PX - 400 * scale) / 2;
            
            printCtx.translate(offsetX, offsetY);
            printCtx.scale(scale, scale);
            
            // Desenhar foto do usuário
            if (userImage) {
                printCtx.save();
                
                const brightness = document.getElementById('brightness').value;
                const contrast = document.getElementById('contrast').value;
                printCtx.filter = `brightness(${100 + parseInt(brightness)}%) contrast(${100 + parseInt(contrast)}%)`;
                
                const baseScale = 0.3;
                const scaledWidth = userImage.width * baseScale * imageZoom;
                const scaledHeight = userImage.height * baseScale * imageZoom;
                
                const centerX = 150;
                const centerY = 200;
                
                const drawX = centerX - scaledWidth / 2 + (imagePosition.x * 1.5);
                const drawY = centerY - scaledHeight / 2 + (imagePosition.y * 1.5);
                
                printCtx.drawImage(userImage, drawX, drawY, scaledWidth, scaledHeight);
                printCtx.restore();
            }
            
            // Desenhar modelo PNG
            if (modelImage) {
                printCtx.drawImage(modelImage, 0, 0, 300, 400);
            }
            
            // Desenhar textos
            const name = document.getElementById('name').value;
            const role = document.getElementById('role').value;
            const location = document.getElementById('location').value;
            
            if (name || role || location) {
                printCtx.filter = 'none';
                printCtx.fillStyle = '#1e3a8a';
                printCtx.textAlign = 'center';
                printCtx.shadowColor = 'rgba(0, 0, 0, 0.1)';
                printCtx.shadowBlur = 1;
                printCtx.shadowOffsetY = 0.5;
                
                if (name) {
                    printCtx.font = 'bold 18px "Segoe UI", Arial, sans-serif';
                    printCtx.fillText(name, 150, 330);
                }
                
                if (role) {
                    printCtx.font = '14px "Segoe UI", Arial, sans-serif';
                    printCtx.fillText(role, 150, 355);
                }
                
                if (location) {
                    printCtx.font = 'bold 16px "Segoe UI", Arial, sans-serif';
                    printCtx.fillStyle = '#3b82f6';
                    printCtx.fillText(location, 150, 380);
                }
            }
            
            const imageData = printCanvas.toDataURL('image/png', 1.0);
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Impressão do Crachá - 85x54mm</title>
                    <style>
                        @page {
                            size: 85mm 54mm;
                            margin: 0;
                        }
                        
                        body { 
                            margin: 0; 
                            padding: 0;
                            display: flex; 
                            justify-content: center; 
                            align-items: center; 
                            min-height: 100vh; 
                            background: white;
                        }
                        
                        .card-container {
                            width: 85mm;
                            height: 54mm;
                            display: flex;
                            justify-content: center;
                            align-items: center;
                            overflow: hidden;
                        }
                        
                        img { 
                            width: 85mm;
                            height: auto;
                            max-height: 54mm;
                            object-fit: contain;
                        }
                        
                        @media screen {
                            body {
                                background: #f0f0f0;
                                padding: 20px;
                            }
                            
                            .card-container {
                                background: white;
                                box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                                border-radius: 8px;
                            }
                        }
                        
                        @media print {
                            @page {
                                size: 85mm 54mm;
                                margin: 0;
                            }
                            
                            body {
                                background: white;
                                padding: 0;
                            }
                            
                            .card-container {
                                width: 85mm;
                                height: 54mm;
                                box-shadow: none;
                                border-radius: 0;
                            }
                            
                            img {
                                width: 85mm;
                                height: 54mm;
                                object-fit: cover;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="card-container">
                        <img src="${imageData}" alt="Crachá">
                    </div>
                    <script>
                        window.onload = function() {
                            const img = document.querySelector('img');
                            img.onload = function() {
                                setTimeout(function() {
                                    window.print();
                                }, 1000);
                            };
                            
                            if (img.complete) {
                                setTimeout(function() {
                                    window.print();
                                }, 1000);
                            }
                        }
                        
                        window.addEventListener('afterprint', function() {
                            // window.close();
                        });
                    </script>
                </body>
                </html>
            `);
            printWindow.document.close();
        });

        // Inicializar
        updateSliderValues();
        
        // Mostrar uma mensagem inicial
        ctx.fillStyle = '#6b7280';
        ctx.textAlign = 'center';
        ctx.font = '16px "Segoe UI", Arial, sans-serif';
        ctx.fillText('Carregue o modelo PNG e a foto', 150, 200);
        ctx.font = '14px "Segoe UI", Arial, sans-serif';
        ctx.fillText('para começar', 150, 220);
    </script>
</body>
</html>
